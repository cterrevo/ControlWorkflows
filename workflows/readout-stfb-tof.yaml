name: readout-stfb-tof
defaults:
  monitoring_qc_url: "no-op://"
  monitoring_dd_url: "no-op://"
  monitoring_readout_url: "no-op://"
roles:
  - name: readout-stfb-{{ it }}
    for:
      range: "{{ hosts }}"
      var: it
    constraints:
      - attribute: machine_id
        value: "{{ it }}"
    vars:
      readout_cfg_uri: "file:/home/flp/readout_stfb_emu.cfg"
    roles:
      - name: "readout"
        task:
          load: readout
      - name: "stfb-tof"
        connect:
          - name: readout
            type: pull
            target: "{{ Parent().Path }}.readout:readout"
            rateLogging: "1"
        task:
          load: stfbuilder-tof
  - name: tof-single-subwf
    defaults:
      tofhost: "{{ FromJson(hosts)[0] }}"
      dpl_config: "/etc/flp.d/qc/stfb-tof.dpl.json"
    constraints:
      - attribute: machine_id
        value: "{{ tofhost }}"
    roles:
      - name: "stfb-raw-proxy-tof"
        connect:
          - name: "from_internal-dpl-clock_to_readout-proxy"
            target: "{{Parent().Path}}.internal-dpl-clock:from_internal-dpl-clock_to_readout-proxy"
            type: "pull"
            rateLogging: "60"
          - name: "readout-proxy"
            target: "{{ Up(2).Path }}.readout-stfb-{{ tofhost }}.stfb:dpl-chan"
            #target: "ipc:///tmp/stf-builder-dpl-pipe-0"
            transport: shmem
            type: "pull"
            rateLogging: "1"
        task:
          load: stfb-raw-proxy-tof
      - name: "internal-dpl-clock"
        task:
          load: stfb-internal-dpl-clock-tof
      - name: "stfb-tof-compressor-0"
        connect:
          - name: "from_readout-proxy_to_tof-compressor-0"
            target: "{{Parent().Path}}.stfb-raw-proxy-tof:from_readout-proxy_to_tof-compressor-0"
            type: "pull"
            rateLogging: "60"
        task:
          load: stfb-tof-compressor-0
      - name: "stfb-tof-compressor-1"
        connect:
          - name: "from_readout-proxy_to_tof-compressor-1"
            target: "{{Parent().Path}}.stfb-raw-proxy-tof:from_readout-proxy_to_tof-compressor-1"
            type: "pull"
            rateLogging: "60"
        task:
          load: stfb-tof-compressor-1
      - name: "stfb-tof-compressor-2"
        connect:
          - name: "from_readout-proxy_to_tof-compressor-2"
            target: "{{Parent().Path}}.stfb-raw-proxy-tof:from_readout-proxy_to_tof-compressor-2"
            type: "pull"
            rateLogging: "60"
        task:
          load: stfb-tof-compressor-2
      - name: "stfb-tof-compressor-3"
        connect:
          - name: "from_readout-proxy_to_tof-compressor-3"
            target: "{{Parent().Path}}.stfb-raw-proxy-tof:from_readout-proxy_to_tof-compressor-3"
            type: "pull"
            rateLogging: "60"
        task:
          load: stfb-tof-compressor-3
      - name: "internal-dpl-global-binary-file-sink-tof"
        connect:
          - name: "from_tof-compressor-0_to_internal-dpl-global-binary-file-sink"
            target: "{{Parent().Path}}.stfb-tof-compressor-0:from_tof-compressor-0_to_internal-dpl-global-binary-file-sink"
            type: "pull"
          - name: "from_tof-compressor-1_to_internal-dpl-global-binary-file-sink"
            target: "{{Parent().Path}}.stfb-tof-compressor-1:from_tof-compressor-1_to_internal-dpl-global-binary-file-sink"
            type: "pull"
          - name: "from_tof-compressor-2_to_internal-dpl-global-binary-file-sink"
            target: "{{Parent().Path}}.stfb-tof-compressor-2:from_tof-compressor-2_to_internal-dpl-global-binary-file-sink"
            type: "pull"
          - name: "from_tof-compressor-3_to_internal-dpl-global-binary-file-sink"
            target: "{{Parent().Path}}.stfb-tof-compressor-3:from_tof-compressor-3_to_internal-dpl-global-binary-file-sink"
            type: "pull"
        task:
          load: stfb-internal-dpl-global-binary-file-sink-tof